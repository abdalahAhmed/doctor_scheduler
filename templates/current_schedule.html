{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4 fw-bold" id="page-title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <a id="excel-link" href="{% url 'export_current_schedule' %}" class="btn btn-primary">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ Excel</a>
    <button id="toggle-language" class="btn btn-secondary">ğŸŒ English / Ø¹Ø±Ø¨ÙŠ</button>
  </div>

  {% if week_start_date %}
    <p id="week-start">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: {{ week_start_date }}</p>
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle" id="schedule-table">
        <thead class="table-dark">
          <tr id="table-head">
            <th rowspan="2">Ø§Ù„ÙŠÙˆÙ…</th>
            <th rowspan="2">Ø§Ù„ÙØªØ±Ø©</th>
            {% for col in columns %}
              {% if "Ù†Ù‡Ø§Ø±ÙŠ" in col %}
                <th>{{ col }}</th>
              {% endif %}
            {% endfor %}
            {% for col in columns %}
              {% if "Ù…Ø³Ø§Ø¦ÙŠ" in col %}
                <th>{{ col }}</th>
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for day in days %}
            {% for period in "Ø§Ù„Ø£ÙˆÙ„Ù‰,Ø§Ù„Ø«Ø§Ù†ÙŠØ©"|split:"," %}
              <tr>
                {% if forloop.first %}
                  <td class="fw-bold align-middle" rowspan="2">{{ day }}</td>
                {% endif %}
                <td class="fw-semibold">{{ period }}</td>
                {% for col in columns %}
                  {% if "Ù†Ù‡Ø§Ø±ÙŠ" in col %}
                    <td>{{ schedule_map|get_item:day|get_item:col|get_item:period|safe|default:"â€”" }}</td>
                  {% endif %}
                {% endfor %}
                {% for col in columns %}
                  {% if "Ù…Ø³Ø§Ø¦ÙŠ" in col %}
                    <td>{{ schedule_map|get_item:day|get_item:col|get_item:period|safe|default:"â€”" }}</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h3 class="text-center mt-5 mb-4 fw-bold" id="sessions-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨</h3>
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-dark">
          <tr id="session-head">
            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for doctor_name, session_count in doctor_sessions.items %}
            <tr>
              <td>{{ doctor_name }}</td>
              <td>{{ session_count }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡ Ù„Ø¯ÙŠÙ‡Ù… Ø¬Ù„Ø³Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ.</p>
  {% endif %}
</div>

<style>
  .doctor-role {
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 6px;
    display: inline-block;
  }

  .Ø±Ø¦ÙŠØ³_Ø§Ù„Ù‚Ø³Ù… { background-color: #444; color: white; }
  .Ù†Ø§Ø¦Ø¨_Ø±Ø¦ÙŠØ³_Ø§Ù„Ù‚Ø³Ù… { background-color: #007bff; color: white; }
  .Ø£Ø®ØµØ§Ø¦ÙŠ_Ø£ÙˆÙ„ { background-color: #6a1b9a; color: white; }
  .Ø§Ø³ØªØ´Ø§Ø±ÙŠ { background-color: #dc3545; color: white; }
  .Ø£Ø®ØµØ§Ø¦ÙŠ_Ù†Ø³Ø§Ø¡ { background-color: #f7c6d4; color: black; }
  .Ø£Ø®ØµØ§Ø¦ÙŠ_Ø±Ø¬Ø§Ù„ { background-color: #28a745; color: white; }
  .Ø·Ø¨ÙŠØ¨_Ù…Ù‚ÙŠÙ… { background-color: #17a2b8; color: white; }
  .Ø·Ø¨ÙŠØ¨_Ù…ØªØ¯Ø±Ø¨ { background-color: #cfa4ff; color: black; }
</style>

<script>
  let isEnglish = false;

  const dayMap = {
    "Ø§Ù„Ø£Ø­Ø¯": "Sunday", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†": "Monday", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡": "Tuesday", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡": "Wednesday", "Ø§Ù„Ø®Ù…ÙŠØ³": "Thursday",
    "Sunday": "Ø§Ù„Ø£Ø­Ø¯", "Monday": "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Tuesday": "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Wednesday": "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Thursday": "Ø§Ù„Ø®Ù…ÙŠØ³"
  };

  const periodMap = {
    "Ø§Ù„Ø£ÙˆÙ„Ù‰": "First", "Ø§Ù„Ø«Ø§Ù†ÙŠØ©": "Second",
    "First": "Ø§Ù„Ø£ÙˆÙ„Ù‰", "Second": "Ø§Ù„Ø«Ø§Ù†ÙŠØ©"
  };

  const shiftMap = {
    "Ù†Ù‡Ø§Ø±ÙŠ": "Morning", "Ù…Ø³Ø§Ø¦ÙŠ": "Evening",
    "Morning": "Ù†Ù‡Ø§Ø±ÙŠ", "Evening": "Ù…Ø³Ø§Ø¦ÙŠ"
  };

  document.getElementById("toggle-language").addEventListener("click", () => {
    isEnglish = !isEnglish;

    const tableWrapper = document.querySelector(".table-responsive");
    const table = document.getElementById("schedule-table");

    if (isEnglish) {
      tableWrapper.setAttribute("dir", "ltr");
    } else {
      tableWrapper.setAttribute("dir", "rtl");
    }

    // ØªØºÙŠÙŠØ± Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„
    document.querySelectorAll("#schedule-table thead th").forEach((th, index) => {
      if (index === 0) {
        th.innerText = isEnglish ? "Day" : "Ø§Ù„ÙŠÙˆÙ…";
      } else if (index === 1) {
        th.innerText = isEnglish ? "Period" : "Ø§Ù„ÙØªØ±Ø©";
      } else {
        let text = th.innerText.trim();
        Object.keys(shiftMap).forEach(key => {
          if (text.includes(key)) {
            th.innerText = text.replace(key, shiftMap[key]);
          }
        });
      }
    });

    // ØªØºÙŠÙŠØ± ÙƒÙ„ Ø®Ù„Ø§ÙŠØ§ Body (Ù…Ø´ Ø¨Ø³ Ø£ÙˆÙ„ Ø¹Ù…ÙˆØ¯ ÙˆØªØ§Ù†ÙŠ Ø¹Ù…ÙˆØ¯)
    document.querySelectorAll("#schedule-table tbody td").forEach(cell => {
      const text = cell.innerText.trim();
      
      // Ù„Ùˆ Ø§Ù„Ø®Ù„ÙŠØ© ÙÙŠÙ‡Ø§ ÙŠÙˆÙ…
      if (dayMap[text]) {
        cell.innerText = isEnglish ? dayMap[text] : Object.keys(dayMap).find(key => dayMap[key] === text) || text;
      }
      
      // Ù„Ùˆ Ø§Ù„Ø®Ù„ÙŠØ© ÙÙŠÙ‡Ø§ ÙØªØ±Ø© (Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø£Ùˆ Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
      else if (periodMap[text]) {
        cell.innerText = isEnglish ? periodMap[text] : Object.keys(periodMap).find(key => periodMap[key] === text) || text;
      }
    });

    // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const title = document.querySelector("h2");
    if (title) {
      title.innerText = isEnglish ? "Schedule - Current Week" : "Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ";
    }

    // ØªØºÙŠÙŠØ± Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª
    const sessionHeadCells = document.querySelectorAll("#session-head th");
    if (sessionHeadCells.length >= 2) {
      sessionHeadCells[0].innerText = isEnglish ? "Doctor Name" : "Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨";
      sessionHeadCells[1].innerText = isEnglish ? "Sessions Count" : "Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª";
    }

    // ØªØºÙŠÙŠØ± Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥ÙƒØ³Ù„
    const excelLink = document.getElementById("excel-link");
    if (excelLink) {
      excelLink.href = isEnglish ? "{% url 'export_current_schedule_en' %}" : "{% url 'export_current_schedule' %}";
    }
  });
</script>
{% endblock %}
