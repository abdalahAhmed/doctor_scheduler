{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4 fw-bold" id="page-title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…</h2>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <form method="POST" action="{% url 'generate_schedule' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-success me-2" id="generate-btn">ğŸ” ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</button>
      </form>
      <form method="POST" action="{% url 'move_week' %}" style="display: inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger me-2" id="move-btn">ğŸ“¤ Ù†Ù‚Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
      </form>
    </div>

    <div class="d-flex">
      <button id="edit-toggle" class="btn btn-warning me-2">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
      <a href="{% url 'export_next_schedule' %}" class="btn btn-primary me-2" id="excel-btn">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ Excel</a>
      <button id="toggle-language" class="btn btn-secondary">ğŸŒ English / Ø¹Ø±Ø¨ÙŠ</button>
    </div>
  </div>

  {% if week_start_date %}
    <p id="week-start">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: {{ week_start_date }}</p>

    <form method="POST" action="{% url 'save_schedule_changes' %}">
      {% csrf_token %}
      <input type="hidden" name="week_start_date" value="{{ week_start_date|date:'Y-m-d' }}">

      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle" id="schedule-table">
          <thead class="table-dark">
            <tr id="table-head">
              <th>Ø§Ù„ÙŠÙˆÙ…</th>
              <th>Ø§Ù„ÙØªØ±Ø©</th>
              {% for col in columns %}
                {% if "Ù†Ù‡Ø§Ø±ÙŠ" in col %}
                  <th>{{ col }}</th>
                {% endif %}
              {% endfor %}
              {% for col in columns %}
                {% if "Ù…Ø³Ø§Ø¦ÙŠ" in col %}
                  <th>{{ col }}</th>
                {% endif %}
              {% endfor %}
            </tr>
          </thead>

          <tbody>
            {% for day in days %}
              {% for period in "Ø§Ù„Ø£ÙˆÙ„Ù‰,Ø§Ù„Ø«Ø§Ù†ÙŠØ©"|split:"," %}
                <tr data-day="{{ day }}">
                  <td class="fw-bold align-middle">{{ day }}</td>
                  <td class="fw-bold">{{ period }}</td>

                  {% for col in columns %}
                    {% if "Ù†Ù‡Ø§Ø±ÙŠ" in col %}
                      <td>{{ schedule_map|get_item:day|get_item:col|get_item:period|safe|default:"â€”" }}</td>
                    {% endif %}
                  {% endfor %}
                  {% for col in columns %}
                    {% if "Ù…Ø³Ø§Ø¦ÙŠ" in col %}
                      <td>{{ schedule_map|get_item:day|get_item:col|get_item:period|safe|default:"â€”" }}</td>
                    {% endif %}
                  {% endfor %}
                </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="text-center mt-3">
        <button type="submit" class="btn btn-primary" id="save-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
      </div>
    </form>


  


    <h3 class="text-center mt-5 mb-4 fw-bold" id="sessions-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù„ÙƒÙ„ Ø·Ø¨ÙŠØ¨</h3>
    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-dark">
          <tr id="session-head">
            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for doctor_name, session_count in doctor_sessions.items %}
            <tr>
              <td>{{ doctor_name }}</td>
              <td>{{ session_count }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="2">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·Ø¨Ø§Ø¡ Ù„Ø¯ÙŠÙ‡Ù… Ø¬Ù„Ø³Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù….</p>
  {% endif %}
</div>

<style>
  .doctor-role {
    font-weight: bold;
    padding: 4px 8px;
    border-radius: 6px;
    display: inline-block;
  }

  /* Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø±ØªØ¨Ø© */
  .Ø±Ø¦ÙŠØ³_Ø§Ù„Ù‚Ø³Ù… { background-color: #444; color: white; }
  .Ù†Ø§Ø¦Ø¨_Ø±Ø¦ÙŠØ³_Ø§Ù„Ù‚Ø³Ù… { background-color: #007bff; color: white; }
  .Ø£Ø®ØµØ§Ø¦ÙŠ_Ø£ÙˆÙ„ { background-color: #6a1b9a; color: white; }
  .Ø§Ø³ØªØ´Ø§Ø±ÙŠ { background-color: #dc3545; color: white; }
  .Ø£Ø®ØµØ§Ø¦ÙŠ_Ù†Ø³Ø§Ø¡ { background-color: #f7c6d4; color: black; }
  .Ø£Ø®ØµØ§Ø¦ÙŠ_Ø±Ø¬Ø§Ù„ { background-color: #28a745; color: white; }
  .Ø·Ø¨ÙŠØ¨_Ù…Ù‚ÙŠÙ… { background-color: #17a2b8; color: white; }
  .Ø·Ø¨ÙŠØ¨_Ù…ØªØ¯Ø±Ø¨ { background-color: #cfa4ff; color: black; }

  /* âœ… ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
  select.form-select-sm {
    background-color: #fff8e1;
    border: 2px solid #ffc107;
    font-weight: bold;
    font-size: 0.9rem;
  }

  button.btn-danger.ms-2 {
    padding: 2px 6px;
    font-size: 0.85rem;
    background-color: #ff5c5c;
    border: none;
    border-radius: 4px;
  }

  td select:focus {
    outline: none;
    border-color: #ff9800;
    box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.5);
  }
</style>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    const doctorList = {{ all_doctors|safe }} || [];
    let isEnglish = false;

    const editToggle = document.getElementById("edit-toggle");
    if (editToggle) {
      editToggle.addEventListener("click", () => {
        const rows = document.querySelectorAll("#schedule-table tbody tr");
        let previousDay = null;

        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          if (cells.length < 2) return;

          // âœ… Ù†Ù‚Ø±Ø£ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø®Ø§ØµÙŠØ© data-day Ø£Ùˆ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚
          let currentDay = row.getAttribute("data-day")?.trim();
          if (!currentDay && previousDay) {
            currentDay = previousDay;
          }
          if (currentDay) previousDay = currentDay;

          const period = cells[1]?.innerText?.trim() || '';
          if (!currentDay || !period) return;

          // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø¨Ù‚ÙˆØ§Ø¦Ù… Ù…Ù†Ø³Ø¯Ù„Ø©
          cells.forEach((cell, i) => {
            if (i < 2) return;

            const header = document.querySelector(`#schedule-table thead th:nth-child(${i + 1})`);
            if (!header) return;

            const clinicShift = header.innerText.trim();
            if (!clinicShift || clinicShift === "Ø§Ù„ÙŠÙˆÙ…" || clinicShift === "Ø§Ù„ÙØªØ±Ø©") return;

            const span = cell.querySelector("span");
            const currentValue = span ? span.textContent.trim() : cell.textContent.trim();

            const select = document.createElement("select");
            select.classList.add("form-select", "form-select-sm");
            select.name = `assignment__${currentDay}__${clinicShift}__${period}`;

            const hiddenOriginal = document.createElement("input");
            hiddenOriginal.type = "hidden";
            hiddenOriginal.name = `assignment__${currentDay}__${clinicShift}__${period}__original`;
            hiddenOriginal.value = currentValue;

            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.text = "Ø§Ø®ØªØ± Ø·Ø¨ÙŠØ¨Ù‹Ø§";
            select.appendChild(defaultOption);

            doctorList.forEach((doc) => {
              const option = document.createElement("option");
              option.value = doc;
              option.text = doc;
              if (doc === currentValue) option.selected = true;
              select.appendChild(option);
            });

            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.textContent = "ğŸ—‘ï¸";
            removeBtn.classList.add("btn", "btn-sm", "btn-danger", "ms-2");
            removeBtn.onclick = () => { select.value = ""; };

            cell.innerHTML = "";
            cell.appendChild(select);
            cell.appendChild(removeBtn);
            cell.appendChild(hiddenOriginal);
          });
        });
      });
    }

    // âœ… Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ© ÙƒÙ…Ø§ Ù‡Ùˆ
    const dayMap = {
      "Ø§Ù„Ø£Ø­Ø¯": "Sunday", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†": "Monday", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡": "Tuesday", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡": "Wednesday", "Ø§Ù„Ø®Ù…ÙŠØ³": "Thursday",
      "Sunday": "Ø§Ù„Ø£Ø­Ø¯", "Monday": "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Tuesday": "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Wednesday": "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Thursday": "Ø§Ù„Ø®Ù…ÙŠØ³"
    };

    const periodMap = {
      "Ø§Ù„Ø£ÙˆÙ„Ù‰": "First", "Ø§Ù„Ø«Ø§Ù†ÙŠØ©": "Second",
      "First": "Ø§Ù„Ø£ÙˆÙ„Ù‰", "Second": "Ø§Ù„Ø«Ø§Ù†ÙŠØ©"
    };

    const shiftMap = {
      "Ù†Ù‡Ø§Ø±ÙŠ": "Morning", "Ù…Ø³Ø§Ø¦ÙŠ": "Evening",
      "Morning": "Ù†Ù‡Ø§Ø±ÙŠ", "Evening": "Ù…Ø³Ø§Ø¦ÙŠ"
    };

    document.getElementById("toggle-language").addEventListener("click", () => {
      isEnglish = !isEnglish;

      const tableWrapper = document.querySelector(".table-responsive");
      if (tableWrapper) {
        tableWrapper.setAttribute("dir", isEnglish ? "ltr" : "rtl");
      }

      document.querySelectorAll("#schedule-table thead th").forEach((th, index) => {
        let text = th.innerText.trim();
        if (index === 0) {
          th.innerText = isEnglish ? "Day" : "Ø§Ù„ÙŠÙˆÙ…";
        } else if (index === 1) {
          th.innerText = isEnglish ? "Period" : "Ø§Ù„ÙØªØ±Ø©";
        } else {
          Object.keys(shiftMap).forEach(key => {
            if (text.includes(key)) {
              th.innerText = text.replace(key, shiftMap[key]);
            }
          });
        }
      });

      document.querySelectorAll("#schedule-table tbody td").forEach(cell => {
        const text = cell.innerText.trim();
        if (dayMap[text]) {
          cell.innerText = isEnglish ? dayMap[text] : Object.keys(dayMap).find(key => dayMap[key] === text) || text;
        } else if (periodMap[text]) {
          cell.innerText = isEnglish ? periodMap[text] : Object.keys(periodMap).find(key => periodMap[key] === text) || text;
        }
      });

      const pageTitle = document.getElementById("page-title");
      if (pageTitle) {
        pageTitle.innerText = isEnglish ? "Schedule - Next Week" : "Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª - Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…";
      }

      const weekStart = document.getElementById("week-start");
      if (weekStart) {
        weekStart.innerText = (isEnglish ? "Week Start: " : "Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ") + "{{ week_start_date }}";
      }

      const sessionHeadCells = document.querySelectorAll("#session-head th");
      if (sessionHeadCells.length >= 2) {
        sessionHeadCells[0].innerText = isEnglish ? "Doctor Name" : "Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨";
        sessionHeadCells[1].innerText = isEnglish ? "Sessions Count" : "Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª";
      }

      const saveBtn = document.getElementById("save-btn");
      if (saveBtn) {
        saveBtn.innerText = isEnglish ? "ğŸ’¾ Save Changes" : "ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
      }

      const excelBtn = document.getElementById("excel-btn");
      if (excelBtn) {
        excelBtn.href = isEnglish
          ? "{% url 'export_next_schedule_en' %}"
          : "{% url 'export_next_schedule' %}";
        excelBtn.innerText = isEnglish ? "â¬‡ï¸ Download Excel" : "â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ Excel";
      }
    });
  });
</script>


{% endblock %}