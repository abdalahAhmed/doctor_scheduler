{% extends "base.html" %}
{% block title %}ุชุนุฏูู ุจูุงูุงุช ุงูุทุจูุจ{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-4 text-center fw-bold">ุชุนุฏูู ุงูุทุจูุจ: {{ doctor.name }}</h2>

  <form method="post">
    {% csrf_token %}
    <!-- ุงูุงุณู -->
    <div class="mb-3">
      <label class="form-label">ุงุณู ุงูุทุจูุจ</label>
      <input type="text" class="form-control" name="name" value="{{ doctor.name }}" required>
    </div>

    <!-- ุงูุฑุชุจุฉ -->
    <div class="mb-3">
      <label class="form-label">ุงูุฑุชุจุฉ</label>
      <div class="d-flex flex-wrap gap-2">
        {% for role in roles %}
          <button type="button" class="btn btn-outline-primary {% if doctor.specialty == role %}active{% endif %}" onclick="selectRole('{{ role }}', this)">{{ role }}</button>
        {% endfor %}
      </div>
      <input type="hidden" name="specialty" id="specialtyInput" value="{{ doctor.specialty }}">
    </div>

    <!-- ุงูุญุฏ ุงูุฃูุตู ููุฌูุณุงุช -->
    <div class="mb-3">
      <label class="form-label">ุงูุญุฏ ุงูุฃูุตู ููุฌูุณุงุช</label>
      <input type="number" class="form-control" name="max_sessions" value="{{ doctor.max_sessions }}" required>
    </div>

    <!-- ุชูุถููุงุช ุงูุนูุงุฏุงุช -->
    <div class="mb-3">
      <label class="form-label">ุชูุถููุงุช ุงูุนูุงุฏุงุช</label>
      <div class="d-flex flex-wrap gap-2">
        {% for clinic in clinic_names %}
          <button type="button" class="btn btn-outline-secondary {% if clinic in doctor.preferred_clinics %}active{% endif %}" onclick="toggleSelection(this, 'preferred_clinics')">{{ clinic }}</button>
        {% endfor %}
      </div>
      <input type="hidden" name="preferred_clinics" id="preferred_clinicsInput">
    </div>

    <!-- ุงูุฃูุงู ุงูููุถูุฉ -->
    <div class="mb-3">
      <label class="form-label">ุงูุฃูุงู ุงูููุถูุฉ (ุญุฏุฏ ุงููุชุฑุฉ)</label>
      <div class="d-flex flex-wrap gap-2">
        {% for day in work_days %}
          <div class="day-block">
            <button type="button" class="btn btn-outline-success" onclick="toggleDay('{{ day }}', 'preferred')">{{ day }}</button>
            <div id="preferred-{{ day }}" class="mt-2" style="display: none;">
              <button type="button" class="btn btn-outline-success mb-1" onclick="togglePreferredDay('{{ day }}', 'ููุงุฑู', this)">ููุงุฑู</button>
              <button type="button" class="btn btn-outline-success" onclick="togglePreferredDay('{{ day }}', 'ูููู', this)">ูููู</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <input type="hidden" name="preferred_days" id="preferred_daysInput">
    </div>

    <!-- ุงูุฃูุงู ุบูุฑ ุงููุชุงุญุฉ -->
    <div class="mb-3">
      <label class="form-label">ุงูุฃูุงู ุบูุฑ ุงููุชุงุญุฉ (ุญุฏุฏ ุงููุชุฑุฉ)</label>
      <div class="d-flex flex-wrap gap-2">
        {% for day in work_days %}
          <div class="day-block">
            <button type="button" class="btn btn-outline-danger" onclick="toggleDay('{{ day }}', 'unavailable')">{{ day }}</button>
            <div id="unavailable-{{ day }}" class="mt-2" style="display: none;">
              <button type="button" class="btn btn-outline-danger mb-1" onclick="toggleUnavailableDay('{{ day }}', 'ููุงุฑู', this)">ููุงุฑู</button>
              <button type="button" class="btn btn-outline-danger" onclick="toggleUnavailableDay('{{ day }}', 'ูููู', this)">ูููู</button>
            </div>
          </div>
        {% endfor %}
      </div>
      <input type="hidden" name="unavailable_days" id="unavailable_daysInput">
    </div>

    <!-- ุชูุถููุงุช ุงูููุงูุจุฉ -->
    <div class="mb-3">
      <label class="form-label">ุชูุถููุงุช ุงูููุงูุจุฉ</label>
      <div class="d-flex flex-wrap gap-2">
        {% for shift in shift_types %}
          <button type="button" class="btn btn-outline-dark {% if shift in doctor.shift_preference %}active{% endif %}" onclick="toggleSelection(this, 'shift_preference')">{{ shift }}</button>
        {% endfor %}
      </div>
      <input type="hidden" name="shift_preference" id="shift_preferenceInput">
    </div>

    <!-- ูุฏุฑุจ -->
    <div class="form-check mb-4">
      <input class="form-check-input" type="checkbox" name="has_training" id="has_training" {% if doctor.has_training %}checked{% endif %}>
      <label class="form-check-label" for="has_training">ูุฏุฑุจุ</label>
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-primary px-5">๐พ ุชุญุฏูุซ</button>
      <a href="{% url 'doctors_list' %}" class="btn btn-secondary px-4">ุฅูุบุงุก</a>
    </div>
  </form>
</div>

<!-- JavaScript -->
<script>
  const selections = {
    preferred_clinics: {{ doctor.preferred_clinics|safe }},
    preferred_days: {{ doctor.preferred_days|safe }},
    unavailable_days: {{ doctor.unavailable_days|safe }},
    shift_preference: {{ doctor.shift_preference|safe }}
  };

  function initializeSelections() {
    // ุชุดุบูู ุนุฑุถ ุงูุฃูุงู ุงููู ูุฎุชุงุฑูููุง
    selections['preferred_days'].forEach(item => {
      const [day, shift] = item.split('-');
      const periodsDiv = document.getElementById(`preferred-${day}`);
      if (periodsDiv) {
        periodsDiv.style.display = 'block';  // ุงูุชุญ ุงูุจููู
        periodsDiv.querySelectorAll('button').forEach(btn => {
          if (btn.textContent.trim() === shift) {
            btn.classList.add('active');
          }
        });
      }
    });

    selections['unavailable_days'].forEach(item => {
      const [day, shift] = item.split('-');
      const periodsDiv = document.getElementById(`unavailable-${day}`);
      if (periodsDiv) {
        periodsDiv.style.display = 'block';  // ุงูุชุญ ุงูุจููู
        periodsDiv.querySelectorAll('button').forEach(btn => {
          if (btn.textContent.trim() === shift) {
            btn.classList.add('active');
          }
        });
      }
    });

    for (let key in selections) {
      document.getElementById(`${key}Input`).value = selections[key].join(",");
    }
  }

  document.addEventListener('DOMContentLoaded', initializeSelections);

  function toggleSelection(btn, field) {
    const value = btn.textContent.trim();
    const index = selections[field].indexOf(value);
    if (index === -1) {
      selections[field].push(value);
      btn.classList.add("active");
    } else {
      selections[field].splice(index, 1);
      btn.classList.remove("active");
    }
    document.getElementById(`${field}Input`).value = selections[field].join(",");
  }

  function toggleDay(day, type) {
    const periodsDiv = document.getElementById(`${type}-${day}`);
    periodsDiv.style.display = periodsDiv.style.display === 'none' ? 'block' : 'none';
  }

  function togglePreferredDay(day, period, btn) {
    const value = `${day}-${period}`;
    const index = selections['preferred_days'].indexOf(value);
    if (index === -1) {
      selections['preferred_days'].push(value);
      btn.classList.add("active");
    } else {
      selections['preferred_days'].splice(index, 1);
      btn.classList.remove("active");
    }
    document.getElementById('preferred_daysInput').value = selections['preferred_days'].join(",");
  }

  function toggleUnavailableDay(day, period, btn) {
    const value = `${day}-${period}`;
    const index = selections['unavailable_days'].indexOf(value);
    if (index === -1) {
      selections['unavailable_days'].push(value);
      btn.classList.add("active");
    } else {
      selections['unavailable_days'].splice(index, 1);
      btn.classList.remove("active");
    }
    document.getElementById('unavailable_daysInput').value = selections['unavailable_days'].join(",");
  }

  function selectRole(value, btn) {
    document.getElementById("specialtyInput").value = value;
    document.querySelectorAll("button[onclick^='selectRole']").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }
</script>
{% endblock %}
